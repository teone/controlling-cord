<!DOCTYPE html>
  <meta charset="utf-8">
  <head>
    <style>

      body {
        width: 100%;
        height: 100%;
      }

      .node {
        cursor: pointer;
      }

      .node rect {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
      }

      .node text {
        font: 10px sans-serif;
      }

      .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
      }

    </style>
  </head>
  <body>
  <script
    src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
    crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="helpers/tree.helpers.js"></script>
  <script>

    var margin = {top: 20, right: 120, bottom: 20, left: 120};
    var padding = 10;
    var radius = 10;
    var width = $('body').width() - margin.right - margin.left;
    var height = 800 - margin.top - margin.bottom;

    var treeData = {
      name: 'xProto',
      x0: height / 2,
      y0: 0,
      children: []
    };

    // import functions from helpers
    var addItem = window.diagram.addItem;
    var removeItem = window.diagram.removeItem;

    var _transitions = [
      addItem('grpc', 'xProto', treeData),
      addItem('chameleon', 'grpc', treeData),
      addItem('rest', 'chameleon', treeData),
      addItem('xos-tosca', 'grpc', treeData),
      addItem('tosca', 'xos-tosca', treeData),
      addItem('json', 'xProto', treeData),
      addItem('xos-gui', 'json', treeData),
      addItem('web interface', 'xos-gui', treeData),
      addItem('redis', 'xProto', treeData),
      addItem('xos-ws', 'redis', treeData),
      addItem('web sockets', 'xos-ws', treeData),
    ];

    var _inverse_transitions = [
      removeItem('grpc', treeData),
      removeItem('chameleon', treeData),
      removeItem('rest', treeData),
      removeItem('xos-tosca', treeData),
      removeItem('tosca', treeData),
      removeItem('json', treeData),
      removeItem('xos-gui', treeData),
      removeItem('web interface', treeData),
      removeItem('redis', treeData),
      removeItem('xos-ws', treeData),
      removeItem('web sockets', treeData),
    ];

    var duration = 750;

    var tree = d3.layout.tree()
      .size([height, width]);

    var diagonal = d3.svg.diagonal()
      .projection(function(d) { return [d.y, d.x]; });

    var svg = d3.select("body").append("svg")
      .attr({
        width: width + margin.right + margin.left,
        height: height + margin.top + margin.bottom
      })
      .append("g")
      .attr({
        transform: "translate(" + margin.left + "," + margin.top + ")"
      });

    function update(data) {
      // create the tree
      var nodes = tree.nodes(treeData);
      var links = tree.links(nodes);

      renderNodes(nodes, data);

      // update links
      var link = svg.selectAll("path.link")
        .data(links, function(d) { return d.target.name; });

      // Enter any new links at the parent's previous position.
      link.enter().insert("path", "g")
        .attr("class", "link")
        .attr("d", function(d) {
          var o = {x: d.source.x0, y: d.source.y0};
          return diagonal({source: o, target: o});
        });

      // Transition links to their new position.
      link.transition()
        .duration(duration)
        .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
        .duration(duration)
        .attr("d", function(d) {
          var o = {x: d.source.x, y: d.source.y};
          return diagonal({source: o, target: o});
        })
        .remove();

      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // start the tree
    update(treeData);

    // helpers
    function renderNodes(nodes, data) {
      var node = svg.selectAll("g.node")
        .data(nodes, function(d) { return d.name });

      // Enter any new nodes at the parent's previous position.
      var nodeEnter = node.enter().append("g")
        .attr({
          class: "node",
          transform: function(d) {
            var x = d.parent !== undefined ? d.parent.y0 : data.y0;
            var y = d.parent !== undefined ? d.parent.x0 : data.x0;
            return "translate(" + x + "," + y + ")";
          }
        });

      nodeEnter.append("rect")
        .attr({
          width: 0,
          height: 0,
          x: 0,
          y: 0,
          rx: radius,
          ry: radius
        });

      var text = nodeEnter.append('text')
        .attr({
          'text-anchor': 'middle',
          'alignment-baseline': 'middle',
          opacity: 0
        })
        .style({
          'font-size': '20px'
        })
        .text(function (d) {return d.name});

      // Transition nodes to their new position.
      var nodeUpdate = node.transition()
        .duration(duration)
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

      nodeUpdate.select("rect")
        .attr({
          width: function (d) {
            return getSiblingTextSize(this).width + (padding * 2);
          },
          height: 50,
          x: function (d) {
            return - ((getSiblingTextSize(this).width + (padding * 2))/2);
          },
          y: -25
        });

      nodeUpdate.select("text")
        .attr({
          opacity: 1
        });

      // Transition exiting nodes to the parent's new position.
      var nodeExit = node.exit().transition()
        .duration(duration)
        .attr("transform", function(d) {
          var x = d.parent !== undefined ? d.parent.y : data.y0;
          var y = d.parent !== undefined ? d.parent.x : data.x0;
          return "translate(" + x + "," + y + ")";
        })
        .remove();

      nodeExit.select("rect")
        .attr({
          width: 0,
          height: 0,
          x: 0,
          y: 0
        });

      nodeExit.select("text")
        .style("fill-opacity", 1e-6);

    }

    function getSiblingTextSize(node) {
      return  d3.select(node.parentNode).select('text').node().getBBox();
    }


  </script>

</body>